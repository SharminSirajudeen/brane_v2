# BRANE Backend Deployment Guide

**Last Updated**: January 25, 2025
**Recommended Platform**: Fly.io + Neon PostgreSQL (100% FREE)

---

## Quick Start (5 Minutes)

```bash
cd backend

# 1. Install Fly CLI
curl -L https://fly.io/install.sh | sh
export PATH="$HOME/.fly/bin:$PATH"

# 2. Launch app (don't deploy yet)
fly launch --name brane-backend --region ord --no-deploy

# 3. Set secrets
fly secrets set \
  DATABASE_URL="<neon-postgres-url>" \
  JWT_SECRET_KEY="<generate-with-python-secrets>" \
  ENCRYPTION_KEY="<generate-with-python-secrets>" \
  DEBUG=false \
  ENVIRONMENT=production

# 4. Deploy
fly deploy

# 5. Verify
curl https://brane-backend.fly.dev/health
```

---

## Prerequisites

1. **Fly.io Account**: Sign up at https://fly.io
2. **Neon PostgreSQL**: Free tier at https://neon.tech
3. **Fly CLI**: Installed (see Quick Start above)

---

## Step-by-Step Setup

### 1. Neon PostgreSQL Setup (FREE Forever)

**Why Neon?**
- 3GB storage (free tier)
- 100 compute hours/month
- No expiration
- Serverless (auto-scales to zero)

**Setup**:
1. Go to https://console.neon.tech
2. Create account
3. Create project: "brane-production"
4. Copy connection string (looks like: `postgresql://user:pass@host/db`)
5. Save it for Step 3 below

### 2. Generate Secrets

```bash
# Generate JWT secret
python3 -c "import secrets; print('JWT_SECRET_KEY=' + secrets.token_urlsafe(32))"

# Generate encryption key
python3 -c "import secrets; print('ENCRYPTION_KEY=' + secrets.token_urlsafe(32))"

# Save both outputs to your password manager!
```

### 3. Fly.io Deployment

```bash
cd backend

# Login to Fly.io
fly auth login

# Launch app (this creates fly.toml)
fly launch --name brane-backend --region ord --no-deploy

# Set all secrets at once
fly secrets set \
  DATABASE_URL='<paste-neon-connection-string>' \
  JWT_SECRET_KEY='<from-step-2>' \
  ENCRYPTION_KEY='<from-step-2>' \
  GOOGLE_CLIENT_ID='<from-google-cloud-console>' \
  GOOGLE_CLIENT_SECRET='<from-google-cloud-console>' \
  DEBUG=false \
  ENVIRONMENT=production

# Deploy!
fly deploy

# Check status
fly status

# View logs
fly logs
```

### 4. Verify Deployment

```bash
# Health check
curl https://brane-backend.fly.dev/health

# Expected response:
# {"status":"ok","version":"0.1.0","environment":"production"}

# API docs
open https://brane-backend.fly.dev/api/docs
```

---

## Environment Variables Reference

### Required

| Variable | Description | Example |
|----------|-------------|---------|
| `DATABASE_URL` | PostgreSQL connection string | `postgresql://user:pass@host/db` |
| `JWT_SECRET_KEY` | Secret for JWT tokens | Generate with `secrets.token_urlsafe(32)` |
| `ENCRYPTION_KEY` | Secret for data encryption | Generate with `secrets.token_urlsafe(32)` |

### Optional

| Variable | Description | Default |
|----------|-------------|---------|
| `DEBUG` | Enable debug mode | `false` |
| `ENVIRONMENT` | Environment name | `production` |
| `GOOGLE_CLIENT_ID` | OAuth client ID | (for Google login) |
| `GOOGLE_CLIENT_SECRET` | OAuth client secret | (for Google login) |
| `OPENAI_API_KEY` | OpenAI API key | (for cloud brain) |
| `ANTHROPIC_API_KEY` | Anthropic API key | (for cloud brain) |

---

## fly.toml Configuration

The `fly.toml` file is auto-generated by `fly launch`. Key sections:

```toml
app = "brane-backend"
primary_region = "ord"  # Chicago

[build]
  # Uses Dockerfile

[env]
  PORT = "8000"

[[services]]
  protocol = "tcp"
  internal_port = 8000

  [[services.ports]]
    port = 80
    handlers = ["http"]

  [[services.ports]]
    port = 443
    handlers = ["tls", "http"]

[http_service]
  internal_port = 8000
  force_https = true

[[vm]]
  memory = '256mb'  # Free tier
  cpu_kind = 'shared'
  cpus = 1
```

---

## Dockerfile Reference

The `Dockerfile` uses multi-stage build for optimization:

**Stage 1**: Build dependencies
- Python 3.11-slim base
- Install system packages
- Install Python dependencies

**Stage 2**: Production runtime
- Copy only needed files
- Run database migrations
- Start with Uvicorn

**Health Check**: Uses `urllib` (stdlib, no extra deps)

---

## Common Commands

### Deploy Updates
```bash
fly deploy
```

### View Logs
```bash
fly logs                   # Stream logs
fly logs --lines 100       # Last 100 lines
```

### SSH Into Machine
```bash
fly ssh console
```

### Scale Resources
```bash
# Free tier
fly scale vm shared-cpu-1x --memory 256

# Paid tier (if needed)
fly scale vm shared-cpu-1x --memory 512
```

### Restart App
```bash
fly apps restart brane-backend
```

### Delete App
```bash
fly apps destroy brane-backend
```

---

## Troubleshooting

### Issue: Deployment fails with "health check timeout"

**Solutions**:
1. Check `Dockerfile` healthcheck uses `urllib` (not `requests`)
2. Ensure port 8000 is exposed
3. Check `fly.toml` internal_port matches `PORT` env var

### Issue: Database connection fails

**Solutions**:
1. Verify `DATABASE_URL` secret is set correctly
2. Check Neon project is running (not paused)
3. Test connection locally:
   ```bash
   psql "<DATABASE_URL>"
   ```

### Issue: App crashes immediately

**Solutions**:
1. Check logs: `fly logs`
2. Verify all required secrets are set: `fly secrets list`
3. Test migrations: `fly ssh console`, then `alembic upgrade head`

### Issue: OAuth redirect fails

**Solutions**:
1. Update Google OAuth redirect URI to: `https://brane-backend.fly.dev/api/auth/google/callback`
2. Ensure `GOOGLE_CLIENT_ID` and `GOOGLE_CLIENT_SECRET` secrets are set

---

## Cost Breakdown (Fly.io Free Tier)

| Resource | Free Tier | Cost |
|----------|-----------|------|
| Compute | Up to 3 shared-cpu-1x VMs, 256MB RAM | **$0** |
| Storage | 3GB persistent volumes | **$0** |
| Bandwidth | 100GB/month | **$0** |
| **Total** | | **$0/month** |

**Combined with Neon Free Tier**:
- PostgreSQL: 3GB storage, 100 compute hours/month
- **Grand Total**: $0/month

---

## Alternatives to Fly.io

### Railway
- **Status**: No longer free ($5/month minimum after trial)
- **Not recommended**: Pricing changed

### Render
- **Free Tier**: Yes, but PostgreSQL expires after 30 days
- **Not recommended**: Database expiration is annoying

### Koyeb
- **Free Tier**: 50 active hours/month
- **Use case**: Good for intermittent use (dev/testing)

### Self-Hosting (VPS)
- **Cost**: $5-10/month (DigitalOcean, Linode, Hetzner)
- **Setup**: Manual Docker deployment
- **Use case**: If you need full control

---

## Security Best Practices

1. **Never commit secrets**: Use `fly secrets set`, never put in `fly.toml`
2. **Regenerate secrets**: If exposed, regenerate immediately
3. **Use HTTPS**: Fly.io enforces this automatically
4. **Rotate credentials**: Change secrets every 90 days
5. **Monitor logs**: Check for suspicious activity

---

## Updating Google OAuth

After deploying, update your Google Cloud Console:

1. Go to https://console.cloud.google.com/apis/credentials
2. Edit your OAuth 2.0 Client ID
3. Add redirect URI: `https://brane-backend.fly.dev/api/auth/google/callback`
4. Save

---

## Next Steps

1. âœ… Backend deployed
2. Update frontend `.env` with backend URL: `VITE_API_URL=https://brane-backend.fly.dev`
3. Deploy frontend (see `/frontend/README.md`)
4. Test full integration
5. Celebrate! ðŸŽ‰

---

**For issues or questions, check Fly.io docs at https://fly.io/docs**
